<div class="container">
    <div class="header">
        <h1 class="title">{{localize .Ctx "PluginManagementTitle"}}</h1>
    </div>

    <div class="table-wrapper">
        <table class="table">
            <thead class="thead">
                <tr>
                    <th class="th">{{localize .Ctx "ID_"}}</th>
                    <th class="th">{{localize .Ctx "Address"}}</th>
                    <th class="th">{{localize .Ctx "Info"}}</th>
                    <th class="th">{{localize .Ctx "Status"}}</th>
                    <th class="th">{{localize .Ctx "Actions"}}</th>
                </tr>
            </thead>
            <tbody>
                {{range .Porters}}
                <tr class="tr">
                    <td class="td">{{.ID_}}</td>
                    <td class="td">{{.Address}}</td>
                    <td class="td">{{.GlobalName}}</td>
                    <td class="td">
                        {{if eq .Status 1}}
                        <span class="badge badge-running">
                            {{localize $.Ctx "Enabled"}}
                        </span>
                        {{else}}
                        <span class="badge badge-stopped">
                            {{localize $.Ctx "Disabled"}}
                        </span>
                        {{end}}
                    </td>
                    <td class="td">
                        <div class="flex space-x-3">
                            {{if eq .Status 1}}
                            <button
                                class="text-red-500 hover:text-red-600 dark:text-red-400 dark:hover:text-red-300
                                toggle-porter transition-colors duration-200"
                                data-id="{{.ID}}"
                                data-action="disable"
                            >
                                {{localize $.Ctx "Disable"}}
                            </button>
                            {{else}}
                            <button
                                class="text-green-500 hover:text-green-600 dark:text-green-400 dark:hover:text-green-300
                                toggle-porter transition-colors duration-200"
                                data-id="{{.ID}}"
                                data-action="enable"
                            >
                                {{localize $.Ctx "Enable"}}
                            </button>
                            {{end}}
                        </div>
                    </td>
                </tr>
                {{else}}
                <tr>
                    <td colspan="5" class="td text-center">
                        {{localize .Ctx "NoPluginData"}}
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>

    <!-- Pagination Control -->
    {{if .Pagination}}
        {{template "pagination" .}}
    {{end}}
</div>

<!-- Confirmation Dialog -->
<div id="toggleModal" class="modal-backdrop">
    <div class="card max-w-md w-full mx-4">
        <div class="content">
            <h3 class="modal-title">{{localize .Ctx "ConfirmAction"}}</h3>
            <p class="modal-text">
                {{localize .Ctx "ConfirmActionText"}} 
                <span id="actionText" class="font-semibold text-slate-900 dark:text-slate-100"></span> 
                {{localize .Ctx "Plugin"}}
            </p>
            <div class="modal-actions">
                <button id="cancelToggle" class="btn-secondary">
                    {{localize .Ctx "Cancel"}}
                </button>
                <button id="confirmToggle" class="btn-primary">
                    {{localize .Ctx "Confirm"}}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleModal = document.getElementById('toggleModal');
        const actionText = document.getElementById('actionText');
        const cancelToggle = document.getElementById('cancelToggle');
        const confirmToggle = document.getElementById('confirmToggle');
        let porterId = null;
        let action = null;

        // Show confirmation dialog
        document.querySelectorAll('.toggle-porter').forEach(button => {
            button.addEventListener('click', function() {
                porterId = this.dataset.id;
                action = this.dataset.action;
                
                if (action === 'enable') {
                    actionText.textContent = 'enable';
                } else {
                    actionText.textContent = 'disable';
                }
                
                toggleModal.classList.remove('hidden');
            });
        });

        // Cancel operation
        cancelToggle.addEventListener('click', function() {
            toggleModal.classList.add('hidden');
            porterId = null;
            action = null;
        });

        // Confirm operation
        confirmToggle.addEventListener('click', function() {
            if (porterId && action) {
                const status = action === 'enable' ? 1 : 0; // 1 for active, 0 for blocked
                
                fetch(`/api/porters/${porterId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: status })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Operation failed');
                    }
                    return response.json();
                })
                .then(data => {
                    toggleModal.classList.add('hidden');
                    // Refresh page to show updated plugin list
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Failed to update plugin status:', error);
                    alert('Failed to update plugin status, please try again');
                });
            }
        });
    });
</script>
