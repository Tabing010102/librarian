<div class="mb-6">
    <h2 class="text-2xl font-bold">
        {{if .User.ID}}{{localize .Ctx "EditUserTitle"}}{{else}}{{localize .Ctx "CreateUserTitle"}}{{end}}
    </h2>
</div>

<form id="userForm" class="space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">{{localize .Ctx "Username"}}</label>
            <input
                    type="text"
                    id="username"
                    name="username"
                    value="{{.User.Username}}"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    required
            >
        </div>

        <div>
            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">{{localize .Ctx "Password"}}</label>
            <input
                    type="password"
                    id="password"
                    name="password"
                    {{if not .User.ID}}required{{end}}
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="{{if .User.ID}}{{localize .Ctx "EmptyPasswordHint"}}{{end}}"
            >
        </div>

        <div>
            <label for="role" class="block text-sm font-medium text-gray-700 mb-1">{{localize .Ctx "Role"}}</label>
            <select
                    id="role"
                    name="role"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
                <option value="user" {{if eq .User.Type 2}}selected{{end}}>{{localize .Ctx "RegularUser"}}</option>
                <option value="admin" {{if eq .User.Type 1}}selected{{end}}>{{localize .Ctx "Administrator"}}</option>
            </select>
        </div>
    </div>

    <div class="flex justify-between pt-4">
        <a href="/users" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded transition duration-200">
            {{localize .Ctx "BackToList"}}
        </a>
        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded transition duration-200">
            {{if .User.ID}}{{localize .Ctx "UpdateUser"}}{{else}}{{localize .Ctx "CreateNewUser"}}{{end}}
        </button>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('userForm');
        const action = "{{.Action}}";
        const method = "{{.Method}}";

        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(form);
            const userData = {};

            for (const [key, value] of formData.entries()) {
                // If editing a user and password is empty, don't send the password field
                if (key === 'password' && value === '' && method === 'PUT') {
                    continue;
                }
                userData[key] = value;
            }

            fetch(action, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData),
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || '{{localize .Ctx "OperationFailed"}}');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Operation successful, redirect to user list page
                    window.location.href = '/users';
                })
                .catch(error => {
                    alert(error.message || '{{localize .Ctx "OperationFailedRetry"}}');
                    console.error('Error:', error);
                });
        });
    });
</script>