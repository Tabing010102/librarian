<div>
    <div class="header">
        <div class="breadcrumbs text-sm">
            <ul>
                <li>{{localize .Ctx "Home"}}</li>
                <li>{{localize .Ctx .Title}}</li>
            </ul>
        </div>
        <button onclick="refreshMetrics()" class="btn btn-primary">
            {{template "icon-refresh" .}}
            {{localize .Ctx "Refresh"}}
        </button>
        <button onclick="toggleAutoRefresh()" id="autoRefreshBtn" class="btn btn-success">
            {{template "icon-clock" .}}
            <span id="autoRefreshText">{{localize .Ctx "AutoRefreshOn"}}</span>
        </button>
        {{if .Debug}}
            <a href="/debug/pprof" target="_blank" class="btn btn-ghost">
                {{template "icon-debug" .}}
                {{localize .Ctx "PprofDebug"}}
            </a>
        {{end}}
    </div>

    <!-- 控制面板 -->
    <div class="card mb-6">
        <div class="card-body">
            <div class="flex flex-wrap items-center gap-4">
                <div class="text-sm text-base-content/60" id="lastUpdate">
                    {{localize .Ctx "LastUpdated"}}: --
                </div>
            </div>
        </div>
    </div>

    <!-- 进程指标卡片 -->
    <div class="grid grid-cols-[repeat(auto-fit,minmax(250px,1fr))] mb-6 gap-6">
        <!-- 进程CPU使用率 -->
        <div class="stats bg-base-100 border-base-300 border">
            <div class="stat">
                <div class="stat-figure text-primary">
                    {{template "icon-cpu" .}}
                </div>
                <div class="stat-title">{{localize .Ctx "ProcessCpuUsage"}}</div>
                <div class="stat-value text-primary" id="processCpuUsage">--</div>
                <div class="stat-desc">{{localize .Ctx "ProcessLoad"}}</div>
            </div>
        </div>

        <!-- 进程内存使用率 -->
        <div class="stats bg-base-100 border-base-300 border">
            <div class="stat">
                <div class="stat-figure text-secondary">
                    {{template "icon-memory" .}}
                </div>
                <div class="stat-title">{{localize .Ctx "ProcessMemoryUsage"}}</div>
                <div class="stat-value text-secondary" id="processMemoryUsage">--</div>
                <div class="stat-desc">{{localize .Ctx "ProcessMemory"}}</div>
            </div>
        </div>

        <!-- 进程硬盘写入 -->
        <div class="stats bg-base-100 border-base-300 border">
            <div class="stat">
                <div class="stat-figure text-accent">
                    {{template "icon-storage" .}}
                </div>
                <div class="stat-title">{{localize .Ctx "ProcessDiskWrite"}}</div>
                <div class="stat-value text-accent" id="processDiskWrite">--</div>
                <div class="stat-desc">{{localize .Ctx "DiskIO"}}</div>
            </div>
        </div>

        <!-- 进程硬盘读取 -->
        <div class="stats bg-base-100 border-base-300 border">
            <div class="stat">
                <div class="stat-figure text-info">
                    {{template "icon-storage" .}}
                </div>
                <div class="stat-title">{{localize .Ctx "ProcessDiskRead"}}</div>
                <div class="stat-value text-info" id="processDiskRead">--</div>
                <div class="stat-desc">{{localize .Ctx "DiskIO"}}</div>
            </div>
        </div>
    </div>

    <!-- 历史趋势图表区域 -->
    <div class="grid grid-cols-[repeat(auto-fit,minmax(250px,1fr))] gap-6 mb-6">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title">{{localize .Ctx "CpuUsageChart"}}</h3>
                <div class="space-y-4">
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-4 h-3 bg-primary rounded"></div>
                        <span>System CPU</span>
                        <div class="w-4 h-3 bg-error rounded"></div>
                        <span>Process CPU</span>
                    </div>
                    <div id="cpuHistoryContainer" class="space-y-2">
                        <!-- CPU历史数据progress条将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h3 class="card-title">{{localize .Ctx "MemoryUsageChart"}}</h3>
                <div class="space-y-4">
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-4 h-3 bg-success rounded"></div>
                        <span>System Memory</span>
                        <div class="w-4 h-3 bg-secondary rounded"></div>
                        <span>Process Memory</span>
                    </div>
                    <div id="memoryHistoryContainer" class="space-y-2">
                        <!-- Memory历史数据progress条将在这里动态生成 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 详细信息 -->
    <div class="card">
        <div class="card-body">
            <h3 class="card-title">{{localize .Ctx "ProcessDetails"}}</h3>
            <div class="grid grid-cols-[repeat(auto-fit,minmax(250px,1fr))] gap-4">
                <div class="stats bg-base-100 border-base-300 border">
                    <div class="stat">
                        <div class="stat-title">{{localize .Ctx "Goroutines"}}</div>
                        <div class="stat-value text-sm" id="goroutines">--</div>
                    </div>
                </div>
                <div class="stats bg-base-100 border-base-300 border">
                    <div class="stat">
                        <div class="stat-title">{{localize .Ctx "GcCount"}}</div>
                        <div class="stat-value text-sm" id="gcCount">--</div>
                    </div>
                </div>
                <div class="stats bg-base-100 border-base-300 border">
                    <div class="stat">
                        <div class="stat-title">{{localize .Ctx "HeapMemory"}}</div>
                        <div class="stat-value text-sm" id="heapMemory">--</div>
                    </div>
                </div>
                <div class="stats bg-base-100 border-base-300 border">
                    <div class="stat">
                        <div class="stat-title">{{localize .Ctx "StackMemory"}}</div>
                        <div class="stat-value text-sm" id="stackMemory">--</div>
                    </div>
                </div>
                <div class="stats bg-base-100 border-base-300 border">
                    <div class="stat">
                        <div class="stat-title">{{localize .Ctx "GcPause"}}</div>
                        <div class="stat-value text-sm" id="gcPause">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>
// 全局变量
let autoRefreshInterval = setInterval(fetchMetrics, 10000);
let isAutoRefresh = true;
let metricsHistory = [];
let lastFetchTime = 0;

// 历史数据点数量常量
const MAX_HISTORY_POINTS = 10;

// 防抖函数
function debounce(func, wait) {
    let timeout;
    return function executedFunction() {
        const args = arguments;
        const later = function() {
            clearTimeout(timeout);
            func.apply(null, args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// 格式化字节数
function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// 格式化数字
function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
}

// 创建进度条HTML
function createProgressBar(systemValue, processValue, timeLabel, type) {
    const colors = type === 'cpu' 
        ? { system: 'bg-primary', process: 'bg-error' }
        : { system: 'bg-success', process: 'bg-secondary' };
    
    return `
        <div class="flex flex-col items-center gap-1 w-12">
            <div class="flex items-end gap-0.5 w-full h-32">
                <div class="flex flex-col h-full items-center flex-1">
                    <div class="w-full h-full bg-base-200 rounded flex flex-col-reverse p-px">
                        <div class="${colors.system} rounded transition-all duration-300" style="height: ${systemValue}%"></div>
                    </div>
                    <span class="text-xs mt-1">${systemValue.toFixed(0)}%</span>
                </div>
                <div class="flex flex-col h-full items-center flex-1">
                    <div class="w-full h-full bg-base-200 rounded flex flex-col-reverse p-px">
                        <div class="${colors.process} rounded transition-all duration-300" style="height: ${processValue}%"></div>
                    </div>
                    <span class="text-xs mt-1">${processValue.toFixed(0)}%</span>
                </div>
            </div>
            <span class="text-xs text-center w-full">${timeLabel}</span>
        </div>
    `;
}

// 更新历史趋势图表
function updateHistoryCharts() {
    const cpuContainer = document.getElementById('cpuHistoryContainer');
    const memoryContainer = document.getElementById('memoryHistoryContainer');
    
    if (!cpuContainer || !memoryContainer) return;
    
    // 获取最近的历史数据
    const recentHistory = metricsHistory.slice(-MAX_HISTORY_POINTS);
    
    // 生成CPU历史progress条
    const cpuBars = recentHistory.map(item => {
        const time = new Date(item.timestamp).toLocaleTimeString().slice(-8, -3); // 只显示时:分
        const systemCpu = (item.data['system.cpu.usage'] && item.data['system.cpu.usage'][0] && item.data['system.cpu.usage'][0].value) || 0;
        const processCpu = (item.data['process.cpu.usage'] && item.data['process.cpu.usage'][0] && item.data['process.cpu.usage'][0].value) || 0;
        return createProgressBar(systemCpu, processCpu, time, 'cpu');
    }).join('');
    
    // 生成Memory历史progress条
    const memoryBars = recentHistory.map(item => {
        const time = new Date(item.timestamp).toLocaleTimeString().slice(-8, -3); // 只显示时:分
        const systemMemory = (item.data['system.memory.usage'] && item.data['system.memory.usage'][0] && item.data['system.memory.usage'][0].value) || 0;
        const processMemory = (item.data['process.memory.usage'] && item.data['process.memory.usage'][0] && item.data['process.memory.usage'][0].value) || 0;
        return createProgressBar(systemMemory, processMemory, time, 'memory');
    }).join('');
    
    cpuContainer.innerHTML = cpuBars ? `<div class="flex justify-between w-full">${cpuBars}</div>` : '<div class="text-center text-base-content/60 py-4">{{localize .Ctx "NoData"}}</div>';
    memoryContainer.innerHTML = memoryBars ? `<div class="flex justify-between w-full">${memoryBars}</div>` : '<div class="text-center text-base-content/60 py-4">{{localize .Ctx "NoData"}}</div>';
}

// 更新指标卡片
function updateMetricCards(data) {
    try {
        const processCpuUsage = (data['process.cpu.usage'] && data['process.cpu.usage'][0] && data['process.cpu.usage'][0].value) || 0;
        const processMemoryUsage = (data['process.memory.usage'] && data['process.memory.usage'][0] && data['process.memory.usage'][0].value) || 0;
        const processDiskWrite = (data['process.disk.write'] && data['process.disk.write'][0] && data['process.disk.write'][0].value) || 0;
        const processDiskRead = (data['process.disk.read'] && data['process.disk.read'][0] && data['process.disk.read'][0].value) || 0;
        const goroutines = (data['process.goroutines'] && data['process.goroutines'][0] && data['process.goroutines'][0].value) || 0;
        const gcCount = (data['process.gc.count'] && data['process.gc.count'][0] && data['process.gc.count'][0].value) || 0;
        const heapMemory = (data['process.memory.heap'] && data['process.memory.heap'][0] && data['process.memory.heap'][0].value) || 0;
        const stackMemory = (data['process.memory.stack'] && data['process.memory.stack'][0] && data['process.memory.stack'][0].value) || 0;
        const gcPause = (data['process.gc.pause_duration'] && data['process.gc.pause_duration'][0] && data['process.gc.pause_duration'][0].value) || 0;

        // 更新进程指标卡片
        const processCpuElement = document.getElementById('processCpuUsage');
        const processMemoryElement = document.getElementById('processMemoryUsage');
        const processDiskWriteElement = document.getElementById('processDiskWrite');
        const processDiskReadElement = document.getElementById('processDiskRead');

        if (processCpuElement) processCpuElement.textContent = processCpuUsage.toFixed(1) + '%';
        if (processMemoryElement) processMemoryElement.textContent = processMemoryUsage.toFixed(1) + '%';
        if (processDiskWriteElement) processDiskWriteElement.textContent = formatBytes(processDiskWrite * 1024 * 1024);
        if (processDiskReadElement) processDiskReadElement.textContent = formatBytes(processDiskRead * 1024 * 1024);

        // 更新详细信息
        const goroutinesElement = document.getElementById('goroutines');
        const gcCountElement = document.getElementById('gcCount');
        const heapElement = document.getElementById('heapMemory');
        const stackElement = document.getElementById('stackMemory');
        const gcPauseElement = document.getElementById('gcPause');

        if (goroutinesElement) goroutinesElement.textContent = formatNumber(goroutines);
        if (gcCountElement) gcCountElement.textContent = formatNumber(gcCount);
        if (heapElement) heapElement.textContent = formatBytes(heapMemory);
        if (stackElement) stackElement.textContent = formatBytes(stackMemory);
        if (gcPauseElement) gcPauseElement.textContent = gcPause.toFixed(2) + 's';

        // 更新时间戳
        const lastUpdateElement = document.getElementById('lastUpdate');
        if (lastUpdateElement) {
            lastUpdateElement.textContent = '{{localize .Ctx "LastUpdated"}}: ' + new Date().toLocaleTimeString();
        }

    } catch (error) {
        console.error('Error updating metric cards:', error);
    }
}

// 获取指标数据
function fetchMetrics() {
    const now = Date.now();
    if (now - lastFetchTime < 2000) return;
    lastFetchTime = now;

    fetch('/api/metrics')
        .then(function(response) {
            if (!response.ok) {
                throw new Error('Failed to fetch metrics');
            }
            return response.json();
        })
        .then(function(data) {
            updateMetricCards(data);
            saveMetricsHistory(now, data);
            updateHistoryCharts();
        })
        .catch(function(error) {
            console.warn('API not available, using test data:', error);
        });
}

function saveMetricsHistory(timestamp, data) {
    // 保存到历史记录
    metricsHistory.push({
        timestamp: timestamp,
        data: data
    });

    // 限制历史记录大小
    if (metricsHistory.length > MAX_HISTORY_POINTS * 2) {
        metricsHistory = metricsHistory.slice(-MAX_HISTORY_POINTS);
    }
}

// 刷新指标（防抖版本）
const refreshMetrics = debounce(fetchMetrics, 1000);

// 切换自动刷新
function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    const text = document.getElementById('autoRefreshText');

    if (isAutoRefresh) {
        clearInterval(autoRefreshInterval);
        isAutoRefresh = false;
        text.textContent = '{{localize .Ctx "AutoRefreshOff"}}';
        btn.className = btn.className.replace('btn-success', 'btn-secondary');
    } else {
        autoRefreshInterval = setInterval(fetchMetrics, 10000); // 10秒间隔
        isAutoRefresh = true;
        text.textContent = '{{localize .Ctx "AutoRefreshOn"}}';
        btn.className = btn.className.replace('btn-secondary', 'btn-success');
    }
}

// 初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始化空的历史数据数组
    metricsHistory = [];

    // 获取初始数据
    fetchMetrics();
});

// 页面卸载时清理
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
